<div class="parcel-details">

  <h2 *ngIf="parcel">{{ parcel.nom || ('Parcelle ' + parcel.id) }}</h2>

  <div *ngIf="loadingParcel">Chargement parcelle...</div>
  <div *ngIf="error" style="color:crimson; margin-top:12px;">{{ error }}</div>

  <div *ngIf="parcel && !loadingParcel" style="margin-top:12px;">
    <p><strong>ID:</strong> {{ parcel.id }}</p>
    <p><strong>Surface:</strong> {{ parcel.surface ?? '-' }}</p>
    <p><strong>Nom de la localisation:</strong> {{ weather?.name || parcel.localisation || '-' }}</p>

    <hr />

    <!-- Coordinates / picker -->
    <div style="margin-bottom:12px;">
      <p><strong>Latitude:</strong> {{ parcel.latitude ?? parcel.lat ?? '-' }}</p>
      <p><strong>Longitude:</strong> {{ parcel.longitude ?? parcel.lng ?? '-' }}</p>
      <p><strong>Altitude:</strong> {{ parcel.altitude ?? '-' }}</p>


    </div>

    <hr />

    <!-- current weather (existing) -->
    <div *ngIf="loadingWeather">Chargement météo...</div>

    <div *ngIf="weather && !loadingWeather">
      <h3>Météo actuelle — {{ weather.name }} {{ weather.sys?.country ? ('(' + weather.sys?.country + ')') : '' }}</h3>
      <p><strong>Temp:</strong> {{ weather.main.temp }} °C (ressenti {{ weather.main.feels_like }} °C)</p>
      <p><strong>Humidité:</strong> {{ weather.main.humidity }}%</p>
      <p *ngIf="weather.wind"><strong>Vent:</strong> {{ weather.wind.speed }} m/s</p>
      <p><strong>Conditions:</strong> {{ weather.weather[0]?.description }}</p>
      <img *ngIf="weather.weather[0]?.icon" [src]="'https://openweathermap.org/img/wn/' + weather.weather[0].icon + '@2x.png'" alt="icon" />
    </div>

    <hr />

    <!-- NEW: Meteo horaire table -->
    <div>
      <h3>Météo horaire (historique)</h3>

      <!-- Date Picker -->
      <mat-form-field appearance="fill" style="margin-bottom: 16px;">
        <mat-label>Sélectionner une date</mat-label>
        <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="onDateChange()" placeholder="JJ/MM/AAAA">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <div *ngIf="loadingMeteo">Chargement météo horaire...</div>
      <div *ngIf="!loadingMeteo && meteoHourly && meteoHourly.length === 0">Aucune donnée horaire disponible.</div>

      <div *ngIf="!loadingMeteo && meteoHourly && meteoHourly.length > 0">
        <table border="1" cellpadding="6" cellspacing="0" width="100%" style="margin-top:8px;">
          <thead>
            <tr>
              <th>Heure</th>
              <th>Température (°C)</th>
              <th>Humidité (%)</th>
              <th>Vent (m/s)</th>
              <th>Pluie (mm)</th>
              <th>Temp < 7°C</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let h of meteoHourly">
              <td>{{ h.date_releve }}</td>
              <td>{{ h.temperature }}</td>
              <td>{{ h.humidite }}</td>
              <td>{{ h.vent }}</td>
              <td>{{ h.pluie }}</td>
              <td>{{ h.temperature < 7 ? 'Oui' : 'Non' }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align: right; font-weight: bold;">Nombre d'heures avec temp < 7°C:</td>
              <td style="font-weight: bold;">{{ nbHeuresTempSous7 ?? '-' }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>